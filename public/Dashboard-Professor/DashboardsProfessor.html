<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/CssDashProfessor/Dashgeral.css">
    <link rel="stylesheet" href="../css/CssDashProfessor/DashboardsProfessor.css">
    <link rel="icon" sizes="56X56" href="../assets/a 1logo-Educare.svg">
    <link href='https://fonts.googleapis.com/css?family=Rubik' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Edu Tech | Dashboard</title>
</head>

<body onload="listarTurmas(), obterDadosgrafico()">

    <div class="modalSuporte" onclick="fecharmodal()">
        <div class="contentSuporte">
            <div class="titleSuporte">Meios de contato</div>
            <div class="EspacoModalSuporte"></div>
            <div class="titleSuporte">
                <a href="https://wa.me/+5511914821813" target="_blank">
                    <img src="../assets/Icon-whatsapp.png" class="iconsModal">
                </a>
                <a href="https://www.instagram.com/theodorsouza42/?next=%2Fbluegodzi%2Ftagged%2F&locale=在
                    线定制塔吉克斯坦TEF证书联系%7B威信%2BTG%2F飞机%3A%40buth2788%7DsjwNH%3F%3F%3F%3F%3F%3Fѧ%3F%3FƾSwQuO"
                    target="_blank">
                    <img src="../assets/icon_insta.webp" class="iconsModal" id="Insta">
                </a>
                <a href="https://mail.google.com/mail/?view=cm&fs=1&to=samukatsouza16@gmail.com&su=
Necessito%20De%20apoio%20com%20a%20tela%20de%20Graficos(dashboard)!&body=Mensagem%20.%20.%20." target="_blank">
                    <img src="../assets/icon_gmail.svg" class="iconsModal" id="google">
                </a>
            </div>
        </div>
    </div>
    <div class="menuLateral">
        <div class="logoEduTech"></div>
        <div class="navegacaoTitulo">
            <span>
                Navegação
            </span>
        </div>
        <div class="containerNavegacao">
            <div class="fileiraSelecionada" onclick="gotoTurmas()">
                <div class="imgFileira">
                    <img src="../assets/chapeuBranco.svg"  width="30px" height="30px">
                </div>
                <div class="tituloFileira">
                    Turmas
                </div>
            </div>
            <div class="fileiraNavegacao">
                <div class="imgFileira">
                    <img src="../assets/descritores.svg" width="23px" height="23px">
                </div>
                <div class="tituloFileira" onclick="gotoMatrizReferencia()">
                    Descritores
                </div>
            </div>
            <div class="fileiraNavegacao">
                <div class="imgFileira">
                    <img src="../assets/bx_support.svg" width="30px" height="30px">
                </div>
                <div class="tituloFileira" onclick="abrirSuporte()">
                    Suporte
                </div>
            </div>
        </div>
        <div class="exit" onclick="SairDaDash()">
            <img src="../assets/sair.svg">
            <span>
                Sair
            </span>
        </div>
    </div>
    <div class="Areadash">
        <div class="AreaKPI">
            <div class="KPI">
                <div class="AreaIconLocal">
                    <img src="../assets/IconDashTurmas.svg" class="IconLocalSelecionadoKPI">
                </div>
                <div class="AreaTextoLocal">
                    <div class="TextoLocal">
                        Dashboards
                    </div>
                    <div class="EspacoTextoLocal">
                        |
                    </div>
                    <div class="AreaTextoLocalSelecionado" id="id_turma">

                    </div>
                </div>
                <div class="EspacoKPI">
                </div>
                <div class="AreaSinoNotificacao">
                    <img src="../assets/sinonotificacaoturma.svg" class="SinoNotificacao">
                </div>
                <div class="AreaEspacoNotificacao">
                    <div class="EspacoNotificacao">
                    </div>
                </div>
                <div class="AreaSobreUsuario">
                    <div class="AreaPrincipalFoto">
                        <div class="AreaSecundariaFoto">
                            <img src="../assets/fotousuarioturma.svg" class="FotoDoUsuario">
                        </div>
                    </div>
                    <div class="AreaDadosDoUsuario">
                        <div class="NomeDoUsuario" id="nome_usuario">Usuaário</div>
                        <div class="CargoDoUsuario" id="cargo_usuario">Cargo</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="AreaDeTrabalho" id="AreaDetrabalhoDash">
            <div class="FileiraKPI">
                <div class="InfoKPIS">
                    <div class="InfoKPISEnglobada">
                        <div class="TituloKPIEnglobada">
                            Média por Proficiência
                        </div>
                        <div class="AreaInfoKPI">
                            <div class="AreaFotoInfoKPI">
                                <div class="ImagemKPI">
                                    <img src="../assets/Icongraficodelinha.svg" class="IconIMG">
                                </div>
                            </div>
                            <div class="AreaTextoInfoKPI" id="AreaTextoComNumeroEVirgula">
                                N/A
                            </div>
                        </div>
                    </div>
                </div>
                <div class="InfoKPIS">
                    <div class="InfoKPISEnglobada">
                        <div class="TituloKPIEnglobada">
                            Alunos Abaixo da Média
                        </div>
                        <div class="AreaInfoKPI">
                            <div class="AreaFotoInfoKPI">
                                <div class="ImagemKPI">
                                    <img src="../assets/fotousuarioturma.svg" class="IconIMG">
                                </div>
                            </div>
                            <div class="AreaTextoInfoKPI" id="KPI_alunos_abaixo_media">
                                N/A
                            </div>
                        </div>
                    </div>
                </div>
                <div class="InfoKPIS">
                    <div class="InfoKPISEnglobada">
                        <div class="TituloKPIEnglobada">
                            Alunos Abaixo do Nível 5
                        </div>
                        <div class="AreaInfoKPI">
                            <div class="AreaFotoInfoKPI">
                                <div class="ImagemKPI">
                                    <img src="../assets/fotousuarioturma.svg" class="IconIMG">
                                </div>
                            </div>
                            <div class="AreaTextoInfoKPI" id="KPI_alunos_abaixo_nivel5" >
                                N/A
                            </div>
                        </div>
                        <div class="AreaImgDuvidaDescritor">
                            <a href="https://download.inep.gov.br/publicacoes/institucionais/avaliacoes_e_exames_da_educacao_basica/escalas_de_proficiencia_do_saeb.pdf"
                                target="_blank" class="ImgDuvidaAlunosAbaixo">
                                <img src="../assets/IconInterrogacaoblack.svg" class="IconInterrogacaoAlunosAbaixo">
                            </a>
                        </div>
                    </div>
                </div>
                <div class="InfoKPIS">
                    <div class="InfoKPISEnglobada">
                        <div class="TituloKPIEnglobada">
                            Maior Dificuldade
                        </div>
                        <div class="AreaInfoKPI">
                            <div class="AreaFotoInfoKPI">
                                <div class="ImagemKPI">
                                    <img src="../assets/imagemAlertaWhiteSkin.svg" class="IconIMG">
                                </div>
                            </div>
                            <div class="AreaTextoInfoKPI" id="AreaTextoSemNumero">
                                N/A
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="Dashboards">
                <div class="InfoDash">
                    <div class="InfoDashEnglobada">
                        <div class="AreaImgDuvidaDescritor">
                            <a id="href_descritor" href="#"
                                target="_blank" class="ImgDuvidaDescritor">
                                <img src="../assets/IconInterrogacaoblack.svg" class="IconInterrogacaoDuvida">
                            </a>
                        </div>
                        <div class="AreaTituloGrafico">
                            Comparação de Erros de Descritores
                        </div>
                        <div class="AreaGrafico">
                            <canvas id="bar-chart" class="Grafico"></canvas>
                        </div>
                        <div class="AreaLegendaInferior">
                            Descritor
                        </div>
                    </div>
                </div>
                <div class="InfoDashAlunosAbaixo">
                    <div class="InfoDashAlunosAbaixoEnglobada">
                        <div class="AreaTituloGrafico">
                            Alunos Com a Nota Mais Baixa
                        </div>
                        <div class="AreaTopPioresAlunos" id="div_rank_alunos">

                        </div>

                        <a href="./Alunos.html" class="AreaLevarParaDescritor">
                            <div class="TextoParaDescritor">
                                Ver mais &rarr;
                            </div>
                        </a>
                    </div>
                </div>
                <!-- <a href="./Sugestoes.html" class="IconLupaParaDescritores">
                    <img src="../assets/IconLupaDashProfe.svg" class="IconLupa">
                </a> -->
            </div>
        </div>
    </div>
</body>

</html>
<script src="../js/sessao.js"></script>
<script>

    function obterDadosgrafico() {
        const idMateria = sessionStorage.getItem('ID_MATERIA');
        fetch(`/dashboardProfessor/obterDadosgrafico/${idMateria}/${idTurmaSelecionada}`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {

                    plotarGrafico(resposta);
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }

    function plotarGrafico(resposta) {
        console.log('Iniciando plotagem do gráfico...');

        // Verifica se resposta contém dados
        if (!Array.isArray(resposta) || resposta.length === 0) {
            console.error('Dados inválidos ou vazios para o gráfico');
            return;
        }

        const barChart = document.getElementById('bar-chart');
        let labels = [];
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Quantidade de Erros',
                data: [],
                borderWidth: 1,
                borderColor: '#113768',
                backgroundColor: '#0790C2',
            }]
        };

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (var i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.descritor);
            dados.datasets[0].data.push(registro.quantidadeErros);
        }

        // Configuração do gráfico
        const config = {
            type: 'bar',
            data: dados,
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {stepSize: 1}
                    }
                }
            }
        };

        let myChart = new Chart(barChart, config);

        // Se necessário, você pode atualizar o gráfico de alguma forma
        // setTimeout(() => atualizarGrafico(dados, myChart), 2000); 
    }

    // function atualizarGrafico(dados, myChart) {
    //     fetch(`/dashboard/tempo-real`, { cache: 'no-store' }).then(function (response) {
    //         if (response.ok) {
    //             response.json().then(function (novoRegistro) {

    //                 obterDadosgrafico();
    //                 console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
    //                 console.log(`Dados atuais do gráfico:`);
    //                 console.log(dados);
    //             });
    //         } else {
    //             console.error('Nenhum dado encontrado ou erro na API');
    //         }
    //     })
    //      .catch(function (error) {
    //          console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    //     });
    // }
  
      function gotoMatrizReferencia(){
        var url = "https://download.inep.gov.br/educacao_basica/saeb/matriz-de-referencia-de-matematica_2001.pdf";
            // Abre a URL em uma nova aba
            window.open(url, '_blank');
    }

    function abrirModais(codigoModal) {
        let listamodais = ['.modalSuporte']
        const modal1 = document.querySelector(listamodais[codigoModal])
        modal1.style.display = 'block'
    }
    function abrirSuporte() {
        let codigoModal = 0
        abrirModais(codigoModal);
    }

    function fecharmodal(codigoModal) {
        let listamodais = ['.modalSuporte']
        for (let i = 0; i <= listamodais.length; i++) {
            let modal1 = document.querySelector(listamodais[i])
            modal1.style.display = 'none'

        }
    }
function gotoTurmas(){
        window.location.href = "EntradaDash.html"
    }

    const idTurmaSelecionada = sessionStorage.getItem('ID_TURMA')
    // id_turma.innerHTML = "Turma: " + idTurmaSelecionada;

    const idUsuario = sessionStorage.getItem('ID_USUARIO');
    const cargoUsuario = sessionStorage.getItem('CARGO_USUARIO');
    const nomeUsuario = sessionStorage.getItem('NOME_USUARIO');

    nome_usuario.innerHTML = nomeUsuario;
    cargo_usuario.innerHTML = cargoUsuario;


    function listarTurmas() {
        fetch(`/dashboardProfessor/listarDesempenhoPorTurma/${idUsuario}/${idTurmaSelecionada}`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {

                    for (let i = 0; i < resposta.length; i++) {
                        let turma = resposta[i];

                        let materia = turma.materia == "MT" ? "Matemática" : "Português";
                        let media = turma.materia == "MT" ? turma.mediaMT : turma.mediaLP;
                        let idMateria = turma.materia == "MT" ? 1 : 0;
                        sessionStorage.setItem('ID_MATERIA', idMateria);

                        const hrefDescritor = document.getElementById('href_descritor');
                        hrefDescritor.href = turma.materia == "MT" ? "https://download.inep.gov.br/educacao_basica/saeb/matriz-de-referencia-de-matematica_2001.pdf" : "https://download.inep.gov.br/educacao_basica/prova_brasil_saeb/menu_do_professor/o_que_cai_nas_provas/Matriz_de_Referencia_de_Lingua_Portuguesa.pdf"

                        getDificuldadePorTurma(turma.idTurma, idMateria)
                            .then(function (dificuldade) {
                                // Agora você tem o valor de dificuldade
                                console.log(`Dificuldade da turma ${turma.idTurma}: ${dificuldade}`);

                                const dificuldadeTurma = verificarDificuldadePorDescritor(dificuldade, idMateria);
                                AreaTextoComNumeroEVirgula.innerHTML = media;
                                AreaTextoSemNumero.innerHTML = dificuldadeTurma;
                                mediaTurma = media;
                            })
                            .catch(function (erro) {
                                // Lida com qualquer erro que aconteça ao obter a dificuldade
                                console.error(`Erro ao obter dificuldade da turma ${turma.idTurma}:`, erro);
                            });

                        listarMediaAlunosPorTurma(media);
                    }
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });

    }

    function getDificuldadePorTurma(idTurma, idMateria) {
        return new Promise(function (resolve, reject) {
            fetch(`/dashboardProfessor/listarDificuldadePorTurma/${idTurma}/${idMateria}`)
                .then(function (resposta) {
                    if (resposta.ok) {
                        if (resposta.status == 204) {
                            reject("Nenhum resultado encontrado!");
                        } else {
                            return resposta.json();  // Retorna a Promise para converter o JSON
                        }
                    } else {
                        reject('Houve um erro na API!');
                    }
                })
                .then(function (dados) {
                    console.log("estou dentro da função");
                    console.log(dados[0].descritor);
                    resolve(dados[0].descritor);  // Resolve a Promise com o valor do descritor
                })
                .catch(function (erro) {
                    console.error(erro);
                    reject(erro);  // Rejeita a Promise em caso de erro
                });
        });
    }


    function verificarDificuldadePorDescritor(descritor, materia) {
        let dificuldadeTurma = 'Nenhum';

        if (materia == 1) {
            if (descritor == 'D1' || descritor == 'D2' || descritor == 'D3' || descritor == 'D4' || descritor == 'D5' || descritor == 'D6' || descritor == 'D7' || descritor == 'D8' || descritor == 'D9' || descritor == 'D10') {
                dificuldadeTurma = 'Espaço e Forma';
            }
            else if (descritor == 'D11' || descritor == 'D12' || descritor == 'D13') {
                dificuldadeTurma = 'Grandezas e Medidas';
            }
            else if (descritor == 'D14' || descritor == 'D15' || descritor == 'D16' || descritor == 'D17' || descritor == 'D18' || descritor == 'D19' || descritor == 'D20' || descritor == 'D21' || descritor == 'D22' || descritor == 'D23' || descritor == 'D24' || descritor == 'D25' || descritor == 'D26' || descritor == 'D27' || descritor == 'D28' || descritor == 'D29' || descritor == 'D30' || descritor == 'D31' || descritor == 'D32' || descritor == 'D33') {
                dificuldadeTurma = 'Álgebra e Funções';
            }
            else if (descritor == 'D34' || descritor == 'D35') {
                dificuldadeTurma = 'Tratamento da Informação';
            }
        }
        else if (materia == 2) {
            if (descritor == 'D1' || descritor == 'D3' || descritor == 'D4' || descritor == 'D6' || descritor == 'D14') {
                dificuldadeTurma = 'Procedimentos de leitura';
            }
            else if (descritor == 'D5' || descritor == '12') {
                dificuldadeTurma = 'Compreensão do texto';
            }
            else if (descritor == 'D20' || descritor == 'D21') {
                dificuldadeTurma = 'Relação entre textos';
            }
            else if (descritor == 'D2' || descritor == 'D7' || descritor == 'D8' || descritor == 'D9' || descritor == 'D10' || descritor == 'D11' || descritor == 'D15') {
                dificuldadeTurma = 'Coerência e coesão';
            }
            else if (descritor == 'D16' || descritor == 'D17' || descritor == 'D18' || descritor == 'D19') {
                dificuldadeTurma = 'Relações entre recursos';
            }
            else if (descritor == 'D13') {
                dificuldadeTurma = 'Variação linguística';
            }
        }


        return dificuldadeTurma;
    }

    function listarMediaAlunosPorTurma(mediaTurma) {
    const idMateria = sessionStorage.getItem('ID_MATERIA') == 1 ? 'mediaMT' : 'mediaLP';
    console.log(idMateria)

        fetch(`/dashboardProfessor/listarMediaAlunosPorTurma/${idUsuario}/${idTurmaSelecionada}/${idMateria}`).then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    throw "Nenhum resultado encontrado!!";
                }
                resposta.json().then(function (resposta) {
                    let qtdAlunosAbaixoMedia = 0;
                    let qtdAlunosAbaixoNivel5 = 0;
                    let contadorRank = 0;

                    for (let i = 0; i < resposta.length; i++) {
                        let aluno = resposta[i];

                        let materia = aluno.materia == "MT" ? "Matemática" : "Português";
                        let media = aluno.materia == "MT" ? aluno.mediaMT : aluno.mediaLP;
                        let idMateria = aluno.materia == "MT" ? 1 : 0;

                        id_turma.innerHTML = aluno.nomeTurma;

                        if (media < mediaTurma) {
                            qtdAlunosAbaixoMedia++;
                        }
                        if (media != null && media.replace(",", ".") < 325) {
                            qtdAlunosAbaixoNivel5++;
                        }

                        relacionarCores(mediaTurma);

                        if(contadorRank < 5){
                            div_rank_alunos.innerHTML += `
                            <div class="InfoAlunoNoTop">
                                 <div class="TextoInfoAlunoNoTop">
                                     ${aluno.nome}
                                 </div>
                                <div class="NotaDoAlunoNoTop" style="color: red;">
                                     ${media}
                                 </div>
                             </div>
                         `;
                        }
                        contadorRank++;
                        
                    }
                    KPI_alunos_abaixo_media.innerHTML = qtdAlunosAbaixoMedia;
                    KPI_alunos_abaixo_nivel5.innerHTML = qtdAlunosAbaixoNivel5;

                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });
    }

    function relacionarCores(mediaProficiencia) {
        const KPI = document.getElementById('AreaTextoComNumeroEVirgula')
        if (mediaProficiencia.replace(",", ".") < 275) {
            KPI.style.color = 'red';
        }
        else if (mediaProficiencia.replace(",", ".") >= 275 && mediaProficiencia.replace(",", ".") < 350) {
            KPI.style.color = '#EEAD2D';
        }
        else if (mediaProficiencia.replace(",", ".") >= 350) {
            KPI.style.color = 'black';
        }
    }

    function SairDaDash(){
        limparSessao();
        window.location.href = "../index.html"
    }
</script>